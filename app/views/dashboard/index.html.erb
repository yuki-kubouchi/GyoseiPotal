<!-- ヘッダー -->
<header class="flex justify-between items-center mb-6">
  <h2 class="text-3xl font-bold text-gray-800">ダッシュボード</h2>
  <div class="flex items-center space-x-4">
    <button onclick="toggleSidebar()" class="p-2 text-gray-600 hover:bg-gray-200 rounded-lg md:hidden">
      <svg class="icon" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <button class="p-2 text-gray-600 hover:bg-gray-200 rounded-full transition duration-150 relative">
      <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
      <span class="absolute top-0 right-0 h-3 w-3 bg-red-500 rounded-full border-2 border-white"></span>
    </button>
    <div class="flex items-center space-x-2 cursor-pointer">
      <div class="h-10 w-10 bg-primary-blue rounded-full flex items-center justify-center text-white font-semibold text-sm">Y.K</div>
      <span class="text-gray-700 font-medium hidden sm:block">窪内行政書士事務所</span>
    </div>
  </div>
</header>

<!-- 統計カードセクション -->
<section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-accent-pending hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-500 uppercase">未完了の申請</p>
      <svg class="icon text-accent-pending" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
    </div>
    <p class="text-4xl font-bold text-gray-900 mt-2"><%= @incomplete_count %></p>
    <p class="text-xs text-gray-400 mt-1">進行中の合計</p>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-accent-warning hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-500 uppercase">次の期限</p>
      <svg class="icon text-accent-warning" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </div>
    <% if @next_due_application %>
      <p class="text-2xl sm:text-3xl font-bold text-gray-900 mt-2"><%= @next_due_application.due_on&.strftime('%Y/%m/%d') %></p>
      <p class="text-xs text-gray-400 mt-1"><%= @next_due_application.customer&.name || @next_due_application.customer&.code %> - <%= @next_due_application.title %></p>
    <% else %>
      <p class="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">-</p>
      <p class="text-xs text-gray-400 mt-1">次の期限はありません</p>
    <% end %>
  </div>
  <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-accent-success hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-500 uppercase">完了 (今月)</p>
      <svg class="icon text-accent-success" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
    </div>
    <p class="text-4xl font-bold text-gray-900 mt-2"><%= @approved_this_month %></p>
    <p class="text-xs text-gray-400 mt-1">承認済み件数</p>
  </div>
  <div id="invoice-total-card" class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-primary-blue hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-500 uppercase">請求総額 (今月)</p>
      <svg class="icon text-primary-blue" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
    </div>
    <div class="flex justify-end mt-2">
      <button id="hide-invoice-card" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-50 text-gray-700">非表示</button>
    </div>
    <p class="text-2xl sm:text-4xl font-bold text-gray-900 mt-2"><%= number_with_delimiter(@invoice_total_yen || 0) %></p>
    <p class="text-xs text-gray-400 mt-1">円</p>
  </div>
  <div id="invoice-total-placeholder" class="hidden bg-white p-6 rounded-2xl shadow-lg border border-dashed border-gray-300 flex items-center justify-center">
    <button id="show-invoice-card" class="px-3 py-1.5 text-sm rounded-lg bg-gray-100 hover:bg-gray-50 text-gray-800">請求総額を表示</button>
  </div>
</section>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <svg class="icon mr-2 text-gray-500" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
          進行中の申請 (トップ5)
        </h3>
        <div class="space-y-4">
          <% @top_applications.each do |a| %>
            <%= link_to application_path(a), class: "p-4 border border-gray-100 rounded-xl hover:shadow-md transition duration-200 cursor-pointer flex justify-between items-center block" do %>
              <div class="flex-1 min-w-0">
                <p class="text-lg font-medium text-gray-900 truncate"><%= a.title %> - <%= a.customer&.name || a.customer&.code %></p>
                <p class="text-sm text-gray-500 mt-1">顧客: <%= a.customer&.code %></p>
              </div>
              <div class="text-right ml-4">
                <% badge_text, badge_bg, badge_text_color = case a.status
                  when "draft" then ["下書き", "bg-blue-100", "text-accent-pending"]
                  when "submitted" then ["提出済み", "bg-yellow-100", "text-accent-warning"]
                  when "reviewing" then ["審査中", "bg-green-100", "text-accent-success"]
                  when "approved" then ["承認", "bg-green-100", "text-accent-success"]
                  else [a.status, "bg-gray-100", "text-gray-600"]
                end %>
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full <%= badge_bg %> <%= badge_text_color %>"><%= badge_text %></span>
                <p class="text-sm font-medium text-gray-700 mt-1">期限: <%= a.due_on&.strftime('%Y/%m/%d') || '-' %></p>
              </div>
            <% end %>
          <% end %>
          <%= link_to "すべての申請を見る →", applications_path, class: "block text-center pt-2 text-primary-blue hover:text-blue-700 font-medium transition duration-150" %>
        </div>
  </section>

  <!-- スケジュール / タイムライン -->
  <section class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <svg class="icon mr-2 text-gray-500" viewBox="0 0 24 24"><path d="M8 2v4M16 2v4M3 10h18M6 14h2M10 14h2M14 14h2M6 18h2M10 18h2M14 18h2M3 8h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V10a2 2 0 0 1 2-2z"></path></svg>
          今後のスケジュール
        </h3>
        <ol class="relative border-l border-gray-200 ml-4">
          <% @upcoming_applications.each do |a| %>
            <li class="mb-6 ml-6">
              <span class="absolute flex items-center justify-center w-3 h-3 bg-primary-blue rounded-full -left-1.5 ring-4 ring-white"></span>
              <h4 class="mb-1 text-lg font-semibold text-gray-900"><%= a.due_on&.strftime('%Y/%m/%d') %></h4>
              <p class="text-sm font-normal text-gray-500"><%= a.customer&.name || a.customer&.code %> - <%= a.title %></p>
            </li>
          <% end %>
          <% if @upcoming_applications.blank? %>
            <li class="ml-6 text-sm text-gray-500">予定はありません</li>
          <% end %>
        </ol>
        <%= link_to "新しい予定を追加", new_application_path, class: "w-full mt-4 py-2 px-4 bg-primary-blue text-white text-center font-medium rounded-xl hover:bg-blue-700 transition duration-150 shadow-md inline-block" %>
  </section>
</div>

<script>
  (function() {
    const card = document.getElementById('invoice-total-card');
    const hideBtn = document.getElementById('hide-invoice-card');
    const placeholder = document.getElementById('invoice-total-placeholder');
    const showBtn = document.getElementById('show-invoice-card');
    if (!card || !placeholder) return;
    const KEY = 'dashboard_hide_invoice_total';
    function applyState(hidden) {
      if (hidden) {
        card.classList.add('hidden');
        placeholder.classList.remove('hidden');
      } else {
        card.classList.remove('hidden');
        placeholder.classList.add('hidden');
      }
    }
    function loadState() { return localStorage.getItem(KEY) === '1'; }
    function saveState(hidden) { localStorage.setItem(KEY, hidden ? '1' : '0'); }
    function init() { applyState(loadState()); }
    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('turbo:load', init);
    if (hideBtn) hideBtn.addEventListener('click', () => { saveState(true); applyState(true); });
    if (showBtn) showBtn.addEventListener('click', () => { saveState(false); applyState(false); });
  })();
</script>

